<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Super Mario</title>
    <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

let config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

let game = new Phaser.Game(config);


/**
 * Función preload() que usamos para la carga de recursos
*/
function preload ()
{
    // Fondo
    this.load.image('fondo', 'assets/images/backgrounds/bg.gif');

    // Suelo y plataformas
    this.load.image('suelo', 'assets/images/backgrounds/suelo.gif');
    this.load.image('plataforma', 'assets/images/backgrounds/plataforma.gif'); 

    // Mario
    this.load.spritesheet('mario', 'assets/images/character/mario_small.gif', { frameWidth: 32, frameHeight: 32 });

    // Moneda
    this.load.image('moneda', 'assets/images/tiles/basement/coin.gif');

    // Sonidos
    this.load.audio('snd_game', ['assets/music/music_main.mp3', 'assets/music/music_main.ogg']);
    this.load.audio('snd_moneda', ['assets/audio/coin.mp3', 'assets/audio/coin.ogg']);

    // Luigi
    this.load.spritesheet('luigi', 'assets/images/character/luigi_small.png', { frameWidth: 32, frameHeight: 32 });

    // Estrella
    this.load.image('star', 'assets/images/tiles/basement/star.gif');
    this.load.audio('snd_estrella', ['assets/audio/star.mp3', 'assets/audio/star.ogg']);

} // preload


let plataformas;
let playerMario;
let cursos;
let direccionMario;
let monedas;
let snd_game;
let snd_moneda;

let playerLuigi;
let keyW, keyA, keyD;
let direccionLuigi;
let estrellas;
let snd_estrella;

/**
 * Función create() que usamos para colocar los objetos en el mundo y 
 * crear elementos para poder usarlos posteriormente.
*/
function create ()
{
    // Añade imagen de fondo en el centro de la ventana
    this.add.image(400, 300, 'fondo');

    // Crea el suelo y las plataformas añadiendolas al sistema de físicas
    plataformas = this.physics.add.staticGroup();
    let suelo = plataformas.create(400, 600 - 32, 'suelo');
    let plataforma1 = plataformas.create(350, 450, 'plataforma');
    let plataforma2 = plataformas.create(650, 350, 'plataforma');

    // Crea el player usando físicas
    playerMario = this.physics.add.sprite(32, 32, 'mario');
    playerMario.setBounce(0.2);
    playerMario.setCollideWorldBounds(true); 

    // Colision entre el player y las plataformas
    this.physics.add.collider(playerMario, plataformas);

    // Animaciones de derecha e izquierda del personaje
    this.anims.create({
        key: 'rightMario',
        frames: this.anims.generateFrameNumbers('mario', { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'leftMario',
        frames: this.anims.generateFrameNumbers('mario', { start: 14, end: 17 }),
        frameRate: 10,
        repeat: -1
    });

    // Crea la variable para los cursores que moveran al personaje
    cursors = this.input.keyboard.createCursorKeys();

    // Dirección a la que mirará por defecto el personaje
    direccionMario = 'right';

    // Creamos 12 monedas repartidas aleatoriamente en el nivel
    monedas = this.physics.add.group();
    for (let i = 0; i < 12; i++)
    {
        let coin = monedas.create(i * 70, 0, 'moneda');
        //Gravedad 'y' entre [800-1200]
        coin.setGravityY(1000-(Math.random()*400-200));
        //Gravedad 'x' entre [-50 y 50]
        coin.setGravityX(Math.random()*100-50);
        coin.setCollideWorldBounds(true);

        // Rebote y entre [0.7-0.9]
        coin.setBounceY(0.7 + Math.random() * 0.2);
        coin.setBounceX(1); //rebote total a los lados
    }

    // Colision entre monedas y plataformas
    this.physics.add.collider(monedas, plataformas);

    // Colision entre monedas y player
    this.physics.add.overlap(playerMario, monedas, getmoneda, null, this);

    // Crear sonidos
    snd_moneda = this.sound.add('snd_moneda');
    snd_main = this.sound.add('snd_game', 1, true);

    // Activar la música de fondo
    snd_main.play();





    // Crea a Luigi usando físicas
    playerLuigi = this.physics.add.sprite(768, 32, 'luigi');
    playerLuigi.setBounce(0.2);
    playerLuigi.setCollideWorldBounds(true); 

    // Colision entre a Luigi y las plataformas
    this.physics.add.collider(playerLuigi, plataformas);

    // Animaciones de derecha e izquierda del personaje
    this.anims.create({
        key: 'rightLuigi',
        frames: this.anims.generateFrameNumbers('luigi', { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'leftLuigi',
        frames: this.anims.generateFrameNumbers('luigi', { start: 14, end: 17 }),
        frameRate: 10,
        repeat: -1
    });

    // Teclas para mover a Luigi
    keyW = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
    keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
    keyD = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);

    direccionLuigi = 'left';

    // Creamos 6 estrellas repartidas aleatoriamente en el nivel
    estrellas = this.physics.add.group();
    for (let i = 0; i < 6; i++)
    {
        let star = estrellas.create(i * 70, 0, 'star');
        //Gravedad 'y' entre [800-1200]
        star.setGravityY(1000-(Math.random()*400-200));
        //Gravedad 'x' entre [-50 y 50]
        star.setGravityX(Math.random()*100-50);
        star.setCollideWorldBounds(true);

        // Rebote y entre [0.7-0.9]
        star.setBounceY(0.7 + Math.random() * 0.2);
        star.setBounceX(1); //rebote total a los lados
    }

    // Colision entre monedas y plataformas
    this.physics.add.collider(estrellas, plataformas);

    // Colision entre monedas y player
    this.physics.add.overlap(playerMario, estrellas, getestrella, null, this);
    this.physics.add.overlap(playerLuigi, estrellas, getestrella, null, this);

    // Crear estrella
    snd_estrella = this.sound.add('snd_estrella');

} // create



/**
 * Función update() que usamos actualizar el estado de los elementos del juego
*/
function update ()
{

    marioMove();
    luigiMove();

} // update

/**
 * Callback getmoneda() que se llama cada vez que se recoge una moneda.
 * Se encarga de desactivar dicha moneda y de instanciar un sonido.
*/
function getmoneda(player, moneda){

    moneda.disableBody(true, true);
    snd_moneda.play();

} // getmoneda


/**
 * Callback getestrella() que se llama cada vez que se recoge una estrella.
 * Se encarga de desactivar dicha estrella y de instanciar un sonido.
*/
function getestrella(player, estrella){

    estrella.disableBody(true, true);
    snd_estrella.play();

} // getestrella


/**
 * Función auxiliar que se encarga del movimiento de Mario
*/
function marioMove(){

    //Parado por defecto
    playerMario.setVelocityX(0);

    //Movimiento
    if (keyA.isDown) { //izquierda
        direccionMario = 'left';
        playerMario.setVelocityX(-150);
        playerMario.anims.play('leftMario', true);
    }
    else if (keyD.isDown) { //derecha
        direccionMario = 'right';
        playerMario.setVelocityX(150);
        playerMario.anims.play('rightMario', true);
    }
    else { // parado
        playerMario.anims.stop();
        if(direccionMario == 'right') //parado hacia la derecha
        playerMario.setFrame(0);
        else //parado hacia la izquierda
        playerMario.setFrame(14);
    }

    //Saltando
    if (!playerMario.body.touching.down) {
        if(direccionMario == 'right')
        playerMario.setFrame(4); // saltando derecha
        else
        playerMario.setFrame(18); // saltando izquierda
    }

    //Saltar (velocidad negativa) cuando toca suelo
    if (keyW.isDown && playerMario.body.touching.down){
        playerMario.setVelocityY(-350);
    }

} // marioMove


/**
 * Función auxiliar que se encarga del movimiento de Luigi
*/
function luigiMove(){

    //Parado por defecto
    playerLuigi.setVelocityX(0);

    //Movimiento
    if (cursors.left.isDown) { //izquierda
        direccionLuigi = 'left';
        playerLuigi.setVelocityX(-150);
        playerLuigi.anims.play('leftLuigi', true);
    }
    else if (cursors.right.isDown) { //derecha
        direccionLuigi = 'right';
        playerLuigi.setVelocityX(150);
        playerLuigi.anims.play('rightLuigi', true);
    }
    else { // parado
        playerLuigi.anims.stop();
        if(direccionLuigi == 'right') //parado hacia la derecha
        playerLuigi.setFrame(0);
        else //parado hacia la izquierda
        playerLuigi.setFrame(14);
    }

    //Saltando
    if (!playerLuigi.body.touching.down) {
        if(direccionLuigi == 'right')
        playerLuigi.setFrame(4); // saltando derecha
        else
        playerLuigi.setFrame(18); // saltando izquierda
    }

    //Saltar (velocidad negativa) cuando toca suelo
    if (cursors.up.isDown && playerLuigi.body.touching.down){
        playerLuigi.setVelocityY(-350);
    }

} // luigiMove

</script>

</body>
</html>